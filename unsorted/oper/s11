	XLIST
	XALL
;
;PDP-11 DEFINITIONS, PAGE 1

IFNDEF MODEL,<MODEL==^D20>
IFE MODEL-^D15,<MODEL==^D20>	;MODELS 15 AND 20 ARE THE SAME
IFE MODEL-^D10,<MODEL==05>	;MODELS 05 AND 10 ARE THE SAME

;
;PDP-11 SIMULATOR, DEFINITIONS DECK.
;R. M. SUPNIK, MARCH 31, 1971
;L. G. FEHSKENS, DECEMBER 26, 1972
;
;1) CPU FAST-AC ASSIGNMENTS:
;
IFL MODEL-^D40, <
	TM=0	;CPU TIMER
	XR=1	;LINKAGE PTR
	TR=2	;TRAP FLAGS (LEFT)
	IR=3	;INSTRUCTION REGISTER
	PS=4	;I/O STATUS (LEFT), CPU STATUS (RIGHT)
	MA=5	;MEMORY ADDRESS.
	DST==6	;DESTINATION OPERAND.
	MB=6	;MEMORY BUFFER.
	DADDR=7	;DESTINATION ADDRESS.
	TRV==7	;TRAP VECTOR
	SADDR=10	;SOURCE ADDRESS.
	ORIG==10	;ORIGINAL DESTINATION (ADD/SUB/CMP/CMPB ONLY)
	XR1==10
	RG==11	;REGISTER SELECTOR (ADDRESS DECODING)
	XR2==11
	SLCT=12	;ADDRESS FIELD.
	XMA==12	;EXTERNAL PAGE MA
	XR3==12
	R=13	;LINK REGISTER FOR ADRSCH
	TMP=14	;TEMPORARY
	TMP1=15
	TMP2=16
	P=17	;STACK POINTER.
>
;PDP-11 DEFINITIONS, PAGE 2
;
;AC ASSIGNMENTS FRO THE 11/40 AND 11/45 DIFFER IN SOME RESPECTS FROM
;THOSE FOR THE 11/05, 11/10, 11/15, AND 11/20
;THE FOLLOWING DIFFERENCES ARE WORTH NOTING FOR ANYONE ALREADY FAMILIAR
;WITH THE 11/20 FAMILY SIMULATION
;  1) TRAPS ARE KEPT IN A MEMORY LOCATION RATHER THAN REGISTER TR.
;  THIS FREES UP AC 2 FOR USE AS THE MEMORY ACCESS FLAGS.
;  2) THE DESTINATION ADDRESS IS KEPT IN A MEMORY LOCATION RATHER THAN
;  IN REGISTER 'DADDR'. THE MEMORY LOCATION IS STILL CALLED DADDR.
;  THE 11/20 CODE TAKES NO ADVANTAGE OF THE FACT THAT DADDR IS AN AC
;  OTHER THAN THE IMPLICIT SPEED OF ACCESS. THIS OBVIATES TRYING TO FIND
; AN AC FOR DADDR THAT WILL NOT BE CLOBBERED BY THE
;  MEMORY ACCESS ROUTINE. IT IS NECESSARY TO PRESERVE
;  A COPY OF THE DESTINATION ADDRESS TO DO THE DATO PART OF A DATIP/DATO
;  BECAUSE THE MA IS OBLITERATED BY THE ACCESS MECHANISM.
;  (NOTE THAT THE DST ADDRESS IS PAGED FOR BOTH THE DATIP AND DATO
;  ACCESSES. AT SOME FUTURE TIME IT MAY PROVE WORTH SOMEONE'S EFFORT
;  TO TREAT DATIP AS A SPECIAL CASE AND GO THROUGH THE PAGING SIMULATION
;  ONLY ONCE.)
;  3) AC'S 13-16 ARE SAVED BEFORE INVOKING BRKCHK OR INTSTP

IFGE MODEL-^D40, <
;AC ASSIGNMENTS FOR 11/40 AND 11/45

;DEDICATED AC'S

	TM=0	;TIMER
	XR=1	;JSP RETURN AC
	MAF=2	;MEMORY ACCESS FLAGS
	IR=3	;INSTRUCTION REGISTER
	PS=4	;PROCESSOR STATUS (RIGHT HALF) AND INTERRUPT LEVEL SUMMARY BITS (LEFT HALF)
	MA=5	;MEMORY ADDRESS

;TEMPORARILY DEDICATED AC'S

	MB=6	;MEMORY BUFFER
	DST=6	;AN ALIAS FOR MB WHEN IT HOLDS A DST OPERAND
	STATE=7	;PROCESSOR STATE
	D=7	;AUTOINCREMENT/DECREMENT DELTA
	ORIG=10	;ORIGINAL DST OPERAND (FOR ADD, SUB, CMP(B))
	REQ=10	;INTERRUPT OR TRAP REQUEST BITS. REQ+1 WILL HAVE REQUEST CODE
	REG=11	;ADDRESS DECODING REGISTER NUMBER
	MOD=12	;ADDRESS DECODING ADDRESS MODE
	APF=12	;PAGE NUMBER FOR SEGMENTATION
	PDR=12	;PAGE DESCRIPTOR REGISTER
	PAR=12	;PAGE ADDRESS REGISTER
	BN=13	;BLOCK NUMBER
	ACF=14	;ACCESS CONTROL FIELD (VERY TEMPRARY)
	XMA=12	;PERIPHERAL BANK TABLE INDEX

;GENUINELY TEMPORARY AC'S
;AC'S 13-16 ARE TRADITIONALLY CLOBBERED ACROSS A CALL TO MIMIC
;FOR BREAKPOINT CONFIRMATION

	R=13	;SECONDARY JSP RETURN AC
	T1=14	;RANDOM LOCAL TEMPORARY
	TMP=14	;SOME TEMPS FOR CODE STOLEN FROM THE 11/20
	TMP1=15
	TMP2=16
	XR1=10
	XR2=11
	XR3=12

;MIMIC SYSTEM STACK POINTER

	S=17	;ONE NAME
	P=17	;AND AN ALIAS.
>
;PDP-11 DEFINITIONS, PAGE 3
;
;2) FAST AC-ASSIGNMENTS FOR PERIPHERALS.  FOR I/O BUS ROUTINES
;    ONLY THE TEMPORARY REGISTERS ARE AVAILABLE.  FOR SERVICE
;    ROUTINES, THE INDICATED PERMANENT REGISTERS CAN ALSO BE USED.
;
	TA1==13	;TEMPORARIES
	TA2==14
	TA3==15
	STA==12	;SHOULD HOLD DEVICE STATUS. SEMI-PERMANENT REG.
;
	PA1==XR	;PERMANENT, IN THAT THEY ARE UNALTERED BY CIO .READ AND .WRITE
	PA2==IR
	PA3==7
;PDP-11 DEFINITIONS, PAGE 4
;
;3) BITS AND PIECES.
;
	CBIT==1	;CONDITION CODE BITS.
	VBIT==2
	ZBIT==4
	NBIT==10
	TBIT==20	;TRACE BIT.
	WBIT==1	;WAIT STATE BIT.

IFL MODEL-^D40, <	STKLIM=400	;STACK TRAP LIMIT>
	HBRK=400000	;BREAK BIT, HALFWORDS
	OBRK=200000	;BREAK BIT, ODD BYTES
	HNOP=100000	;IGNORE I/O WRITE ACTION FLAG, EVEN ADDRESSES
	ONOP=040000	;IGNORE I/O WRITE ACTION FLAG, ODD ADDRESSES

;PDP-11 DEFINITIONS, PAGE 5
;
IFGE MODEL-^D40, <
;11/40 AND 11/45 BIT AND FIELD DEFINITIONS

;FIRST A MACRO TO DEFINE BIT MASKS FROM PDP11 BIT NUMBERS

	DEFINE MASK11(MASK,LEFT,RIGHT)
<IFB <RIGHT>,<MASK==<1_^D'LEFT>>
 IFNB <RIGHT>, <MASK==<1_<^D'LEFT+1>>-<1_<^D'RIGHT>>>
>

;PS BITS

	MASK11 GRSET,11

;INSTRUCTION REGISTER MASKS

	MASK11 IR15,15
	MASK11 IR1514,15,14
	MASK11 IR1513,15,13
	MASK11 IR1413,14,13
	MASK11 IR1412,14,12
	MASK11 IR13,13
	MASK11 IR11,11
	MASK11 IR10,10
	MASK11 IR1009,10,9
	MASK11 IR9,9
	MASK11 IR8,8
	MASK11 IR0703,7,3
	MASK11 IR06,6
	MASK11 IR05,5
	MASK11 IR0504,5,4
	MASK11 IR03,3

;PS MASKS

	MASK11 PS15,15
	MASK11 PS1512,15,12
	MASK11 PS14,14
	MASK11 PS1311,13,11
	MASK11 PS1514,15,14
	MASK11 PS1108,11,8
	MASK11 PS1008,10,8
	MASK11 PS0705,7,5

;SEGMENTATION STATUS REGISTERS
;SR0

	MASK11 QABORT,15,13
	MASK11 SEGENB,0		;SEGMENTATION ENABLED
	MASK11 SR0TRK,6,1	;SR0 ACCESS TRACKING INFORMATION
	MASK11 MMTENB,9		;MEMORY MANAGEMENT TRAPPING ENABLE
	MASK11 MAINT,8		;MAINTENANCE MODE
	MASK11 ICBIT,7		;INSTRUCTION COMPLETED
	MASK11 NRABIT,15	;NONRESIDENT ABORT
	MASK11 PLABIT,14	;PAGE LENGTH ABORT
	MASK11 ROABIT,13	;READ ONLY ABORT
	MASK11 MMTBIT,12	;MEMORY MANAGEMENT TRAP

;PAGE DESCRIPTOR REGISTER

	MASK11 ABIT,7	;ACCESS TRAPPED BIT
	MASK11 PWBIT,6	;PAGE WRITTEN
EDS8==20000	;EXPAND DOWN ROTATED RIGHT 8 BITS


;PDP-11 DEFINITIONS, PAGE 6
;
;NOW A MACRO TO DEFINE SUCCESSIVE BIT FLAGS

	DEFINE NF(FLAG)
<FLAG==F
F==F/2
>
F=400000	;FIRST FLAG AT BIT 0

;MAF LEFT HALF FLAGS

	NF(QREG)	;MA IS REGISTER TABLE INDEX
	NF(QFAC)	;MA IS FLOATING AC NUMBER
	NF(QIMD)	;ADDRESS IS IMMEDIATE
	NF(QDM0)	;DESTINATION MODE WAS 0
	NF(QDR7)	;DESTINATION REGISTER WAS 7 (PC)
	NF(QSM0)	;SOURCE MODE WAS 0 OR IRRELEVANT
	NF(QFPP)	;ADDRESS IS FOR FPP INSTRUCTION
	NF(QFPD)	;FLOATING OPERANDS ARE DOUBLE PRECISION
	NF(QFPL)	;FPP INTEGER OPERANDS ARE LONG
	NF(QIC1)	;INSTRUCTION IS 'CLASS 1'
	NF(QIC2)	;INSTRUCTION IS 'CLASS 2'
	NF(QSDT)	;SOURCE DECODE USES DESTINATION TIMING
	NF(QSFD)	;SOURCE ADDRESS COMES FROM DESTINATION FIELD
	NF(QSTK)	;ACCESS WAS STACKE REFERENCE AND STACK LIMIT SHOULD BE CHECKED ON WRITE
	NF(QR6)		;ADDRESS INVOLVED A STACK POINTER
	NF(QPLA)	;PAGE LENGTH ABORT PENDING
	NF(QRED)	;RED STACK ABORT PENDING
	NF(QNRA)	;NONRESIDENT ABORT PENDING

;MAF LEFT HALF FLAGS

F=400000	;RESET FLAG

	NF(QDST)	;ADDRESS IS OF DESTINATION OPERAND
	NF(QDAT)	;ACCESS IS IN DATA SPACE
	NF(QKER)	;ACCESS IS IN KERNEL STATE
	NF(QCUR)	;ACCESS IS IN CURRENT STATE
	NF(QPRV)	;ACCESS IS IN PREVIOUS STATE
	NF(QBYT)	;ACCESS IS TO BYTE
	NF(QWRT)	;ACCESS IS DATO OR DATOB
	NF(QFPI)	;ACCESS IS TO FPP INTEGER OPERAND
	NF(QFPF)	;ACCESS IS TO FPP FLOATING OPERAND
	NF(QFPC)	;FPP INSTRUCTION IS STCFD/DF
	NF(QINT)	;ACCESS IS TO KT11C INTERNAL REG. SHOULD BE IN LEFT HALF, BUT THERE AIN'T NO ROOM
	NF(QROA)	;READ ONLY ABORT PENDING. LIKEWISE
	NF(QDATIP)	;READ ACCESS IS DATIP, NOT DATI
	NF(QIC3)	;ON 11/40, NEED ANOTHER TIMING CLASS

;PDP-11 DEFINITIONS, PAGE 7
;
;STANDARD COMBINATIONS

RSWCI=QCUR			;READ SOURCE WORD FROM CURRENT DATA SPACE
RSWCD=QCUR+QDAT			;READ SOURCE WORD FROM CURRENT DATA SPACE
RSBCI=QCUR+QBYT		;READ SOURCE BYTE FROM CURRENT INSTRUCTION SPACE (FOR 40)
RSBCD=QBYT+QCUR+QDAT		;READ SOURCE BYTE FROM CURRENT DATA SPACE
RDWCD=QDST+QCUR+QDAT		;READ DESTINATION WORD FROM CURRENT DATA SPACE
RDBCD=QDST+QBYT+QCUR+QDAT	;READ DESTINATION BYTE FROM CURRENT DATA SPACE
WDWCD=QWRT+QDST+QCUR+QDAT	;WRITE DESTINATION WORD TO CURRENT DATA SPACE
WDBCD=QWRT+QDST+QBYT+QCUR+QDAT	;WRITE DESTINATION BYTE TO CURRENT DATA SPACE
RSWPI=QPRV			;READ SOURCE WORD FROM PREVIOUS INSTRUCTON SPACE
RSWPD=QPRV+QDAT			;READ SOURCE WORD FROM PREVIOUS DATA SPCE
WDWPI=QWRT+QDST+QPRV		;WRITE DESTINATION WORD TO PREVIOUS INSTRUCTION SPACE
WDWPD=QWRT+QDST+QPRV+QDAT	;WRITE DESTINATION WORD TO PREVIOUS DATA SPACE
RSWKD=QKER+QDAT			;READ SOURCE WORD FROM KERNEL DATA SPACE
>
;
;PDP-11 DEFINITIONS, PAGE 8
;
;4) I/O DEVICE ASSIGNMENT BITS AND MACROS.
;GIVEN A DEVICE NAMED NAME,
;  NAME'LB= BIT MASK USED IN SETTING/CLEARING BITS
;  IN LEVEL STATUS WORDS.
;
;  NAME'PV= OFFSET FOR POSITION IN BIT# TO VECTOR-ADDRESS TABLE.
;

	EXTERN SMGR


	DEFINE DEV(NM,L)	;DEFINE DEVICE.
<	NM'LB==MLB'L
	MLB'L==MLB'L/2
IFE MLB'L,<	MLB'L==400000>
	NM'PV==PV'L
	PV'L==PV'L+1>


	IOB8==400000	;MASK FOR TRAPS OUTSTANDING (11/40 AND 11/45 ONLY)
	IOB7==200000	;MASK FOR LEVEL 7 IN PS
	IOB6==100000
	IOB5==040000
	IOB4==020000
	IOB3==010000	;LEVELS 3-0 ARE FOR THE 11/45 ONLY
	IOB2==004000
	IOB1==002000

	PV7==0		;COUNTERS FOR DEVICES ASSIGNED TO LEVEL N
	PV6==0
	PV5==0
	PV4==0
	PV3==0
	PV2==0
	PV1==0

	MLB7==400000	;BIT FOR FIRST DEVICE ASSIGNED TO LEVEL N
	MLB6==400000
	MLB5==400000
	MLB4==400000
	MLB3==400000
	MLB2==400000
	MLB1==400000

;PDP-11 DEFINITIONS, PAGE 9
;
;DEVICE ASSIGNMENTS
;
	DEV PIR7,7;	;SOFTWARE INTERRUPTS FOR 11/45
	DEV PIR6,6;	;MUST BE HIGHEST ON EACH LEVEL
	DEV PIR5,5
	DEV PIR4,4
	DEV PIR3,3
	DEV PIR2,2
	DEV PIR1,1

	DEV PTR,4;	;PTR, PTP, TTI, TTO ON LEVEL 4
	DEV PTP,4
	DEV TTI,4
	DEV TTO,4
	DEV DMI,4;	;ALSO DM11
	DEV DMO,4
	DEV D1,4;	;SET ASIDE FIVE DUMMY SLOTS
	DEV D2,4
	DEV D3,4
	DEV D4,4
	DEV D5,4
	DEV UDV,4;	;ALSO GENERIC USER DEVICE.
	DEV TTI2,4;	;ALSO TELETYPES 2-8.
	DEV TTO2,4
	DEV TTI3,4
	DEV TTO3,4
	DEV TTI4,4
	DEV TTO4,4
	DEV TTI5,4
	DEV TTO5,4
	DEV TTI6,4
	DEV TTO6,4
	DEV TTI7,4
	DEV TTO7,4
	DEV TTI8,4
	DEV TTO8,4
	DEV CLK,6;	;CLOCK ON LEVEL 6
	DEV PK,6;	;ALSO PROGRAMMABLE CLOCK
	DEV RF,5;	;RF-, RC-, RK-, RP- ON LEVEL 5
	DEV RK,5
	DEV RP,5
	DEV RC,5
	DEV AD,6;	;AD01 A-TO-D, AS PLUG WIRED
	DEV AD7,7;	;AD01, PROG SELECTABLE BR7
	DEV TC,6;	;DECTAPE ON LEVEL 6
;PDP-11 DEFINITIONS, PAGE 10
;
;5) MACROS OF INTEREST
;
	DEFINE CANCEL(NM)
<	SKIPN ,NM'UCB+UACT
	POPJ P,
	MOVEI TA3,NM'UCB
	MOVEM TA3,.UCBAD
	PJRST .CNCEL
>

	DEFINE ACTIVE(NM,L)
<	SKIPE ,NM'UCB+UACT
	JRST L
	MOVE TA3,TM
	ADD TA3,NM'TIM
	MOVEM TA3,NM'UCB+UTIM
	MOVEI TA3,NM'UCB
	MOVEM TA3,.UCBAD
	PUSHJ P,.ACTVT>

	DEFINE SETINT(NM,ST,L)
<SETDVI:	MOVEI STA,200	;SET DONE BIT IN DEVICE STATUS REG.
	IORB STA,ST
CHKIEB:	TRNN STA,100	;INTERRUPTS ENABLED=1?
	POPJ P,	;NO, EXIT.
SETLVL:	MOVSI TA3,NM'LB	;YES,
	IORM TA3,LVLARY+7-L	;SET BIT IN LEVEL REGISTER.
SETBIT:	TLO PS,IOB'L
	POPJ P,>

	DEFINE CLRINT(NM,ST,L)
<CLRDVI:	MOVEI STA,200	;CLEAR DONE BIT IN STATUS REG.
	ANDCAM STA,ST
CLRLVL:	MOVSI TA3,NM'LB	;CLEAR BIT IN LEVEL REG.
	ANDCAB TA3,LVLARY+7-L
	JUMPN TA3,SETBIT	;IF RESULT 0, CLEAR PS BIT.
	TLZ PS,IOB'L
	POPJ P,>

;PDP-11 DEFINITIONS, PAGE 11
;6) TRAP BIT DEFINITIONS
;TRAP BITS ARE ASSIGNED LEFT TO RIGHT IN 'TR', STARTING AT BIT 1.,
;ACCORDING TO TRAP PRIORITY.
;
	DEFINE NT(A)	;NEXT TRAP
<	A'BIT==TMASK
	A'COD==TCODE
	TMASK==TMASK/2
	TCODE==TCODE+1
>

	TMASK==200000	;INITIAL TRAP BIT IS BIT 1
	TCODE==1

IFL MODEL-^D40,<	;TRAPS FOR 11/05, 11/20 GROUP
	NT(BUS)		;LEVEL 1--BUS ERROR (ODD ADDR)
	NT(MEM)		;BUS ERROR (NON EXISTANT MEMORY)
	NT(ILL)		;LEVEL 2--ILLEGAL MODE WITH JSR/JMP
	NT(RSV)		;RESERVED INSTRUCTION
	NT(BKP)		;BREAK POINT INSTRUCTION
	NT(IOT)		;IOT INSTRUCTION
	NT(EMT)		;EMT INSTRUCTION
	NT(TRP)		;TRAP INSTRUCTION
	NT(TRC)		;LEVEL 3--TRACE TRAP
	NT(STK)		;LEVEL 4--STACK TRAP
	NT(PWR)		;LEVEL 5--POWER FAILURE
>

IFGE MODEL-^D40,<	;TRAPS FOR 11/40, 11/45
	NT(BUS)		;BUS ERROR (ODD ADDRESS)
	NT(RED)		;RED STACK VIOLATION
	NT(SEG)		;SEGMENT VIOLATION
	NT(MEM)		;BUS ERROR (NON-EXISTANT MEMORY)
	NT(PAR)		;PARITY ERROR
	NT(MGM)		;MEMORY MANAGEMENT
	NT(YEL)		;YELLOW STACK VIOLTION
	NT(ILL)		;ILLEGAL INSTRUCTION
	NT(RSV)		;RESERVED INSTRUCTION
	NT(BKP)		;BREAKPOINT INSTRUCTION
	NT(IOT)		;IOT INSTRUCTION
	NT(EMT)		;EMT INSTRUCTION
	NT(TRP)		;TRAP INSTRUCTION
	NT(TRC)		;TRACE TRAP (11/40 ONLY)
	NT(PWR)		;POWER FAILURE
	NT(FPP)		;FPP OR FIS TRAP
>

	LIST
