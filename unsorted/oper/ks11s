	XLIST
	XALL
;
;PDP-11 SIMULATOR, DEFINITIONS DECK.
;R. N. SUPNIK, MARCH 31, 1971
;
;1) CPU FAST-AC ASSIGNMENTS:
;
	TM=0	;CPU TIMER
	XR=1	;LINKAGE PTR
	TR=2	;TRAP FLAGS (LEFT)
	IR=3	;INSTRUCTION REGISTER
	PS=4	;I/O STATUS (LEFT), CPU STATUS (RIGHT)
	MA=5	;MEMORY ADDRESS.
	DST==6	;DESTINATION OPERAND.
	MB=6	;MEMORY BUFFER.
	DADDR=7	;DESTINATION ADDRESS.
	TRV==7	;TRAP VECTOR
	SADDR=10	;SOURCE ADDRESS.
	ORIG==10	;ORIGINAL DESTINATION (ADD/SUB/CMP/CMPB ONLY)
	XR1==10
	SRC=11	;SOURCE OPERAND
	RG==11	;REGISTER SELECTOR (ADDRESS DECODING)
	XR2==11
	SLCT=12	;ADDRESS FIELD.
	XR3==12
	TMP=14	;TEMPORARY
	TMP1=15
	TMP2=16
	T1=TMP1
	T2=TMP2
	P=17	;STACK POINTER.
;
;2) FAST AC-ASSIGNMENTS FOR PERIPHERALS.  FOR I/O BUS ROUTINES
;    ONLY THE TEMPORARY REGISTERS ARE AVAILABLE.  FOR SERVICE
;    ROUTINES, THE INDICATED PERMANENT REGISTERS CAN ALSO BE USED.
;
	TA1==13	;TEMPORARIES
	TA2==14
	TA3==15
	STA==XR3	;SHOULD HOLD DEVICE STATUS. SEMI-PERMANENT REG.
;
	PA1==XR	;PERMANENT
	PA2==IR

	MODEL==^D44	;HOKED UP MODEL NUMBER FO KS11

	PA3==DADDR
;
;PDP-11 DEFINITIONS, PAGE 2
;
;3) BITS AND PIECES.
;
	CBIT=1	;CONDITION CODE BITS.
	VBIT=2
	ZBIT=4
	NBIT=10
	TBIT=20	;TRACE BIT.
	WBIT=1	;WAIT STATE BIT.

	STKLIM=400	;STACK TRAP LIMIT
	HBRK=400000	;BREAK BIT, HALFWORDS
	OBRK=200000	;BREAK BIT, ODD BYTES
	HNOP=100000	;IGNORE I/O WRITE ACTION FLAG, EVEN ADDRESSES
	ONOP=040000	;IGNORE I/O WRITE ACTION FLAG, ODD ADDRESSES

;KS11 SPECIAL DEFINITIONS

	BLKSIZ=100	;NUMBER OF BYTES IN A PROTECTION BLOCK
	HGHBLK=100000	;BYTE NUMBER OF FIRST HIGH SEG BYTE
	PSADDR=177776	;ADDRESS OF PS
	SRADDR=177570	;ADDRESS OF SR
	WPBIT=1		;WRITE PROTECT BIT IN PROTECTION REGISTER
	KSSER=100000	;ERROR BIT IN KSS
	KSSPV=40000	;PROTECTION VIOLATION
	KSSIV=20000	;INSTRUCTION VIOLATION
	UM=100000	;USER M0DE IN PS
	MHR=40000	;MONITOR HIGH SEG RELOCATE
	DREL=20000	;DESTINATION RELOCATE
	SREL=10000	;SOURCE RELOCATE
	UIO=4000	;USER I/O
	EAEENB=2000	;EAE ENABLED
	USP=1000	;USER STACK POINTER
	KSSSD=200	;PV DURING SREL OR DREL
	UTRP=2		;USER TRAP SELECT IN KSPL
;
;4) I/O DEVICE ASSIGNMENT BITS AND MACROS.
;GIVEN A DEVICE NAMED NAME,
;  NAME'LB= BIT MASK USED IN SETTING/CLEARING BITS
;  IN LEVEL STATUS WORDS.
;
;  NAME'PV= OFFSET FOR POSITION IN BIT# TO VECTOR-ADDRESS TABLE.
;

	EXTERN SMGR


	DEFINE DEV(NM,L)	;DEFINE DEVICE.
<	NM'LB=MLB'L
	MLB'L=MLB'L/2
IFE MLB'L,<	MLB'L=400000>
	NM'PV=PV'L
	PV'L=PV'L+1>


	IOB7=400000	;MASK FOR LEVEL 7 IN PS.
	IOB6=200000
	IOB5=100000
	IOB4=040000
	PV7=0	;COUNTERS FOR DEVICES ASSIGNED TO LEVEL 'N'
	PV6=0
	PV5=0
	PV4=0
	MLB7=400000	;BIT FOR FIRST DEVICE ASSIGNED TO LEVEL 7.
	MLB6=400000
	MLB5=400000
	MLB4=400000

	DEV PTR,4;	;PTR, PTP, TTI, TTO ON LEVEL 4
	DEV PTP,4
	DEV TTI,4
	DEV TTO,4
	DEV DMI,4;	;DM-11
	DEV DMO,4
	DEV D1,4;	;SET ASIDE 5 DUMMY SLOTS
	DEV D2,4
	DEV D3,4
	DEV D4,4
	DEV D5,4
	DEV UDV,4;	;ALSO GENERIC USER DEVICE
	DEV TTI2,4;	;ALSO TELTYPES 2-8
	DEV TTO2,4
	DEV TTI3,4
	DEV TTO3,4
	DEV TTI4,4
	DEV TTO4,4
	DEV TTI5,4
	DEV TTO5,4
	DEV TTI6,4
	DEV TTO6,4
	DEV TTI7,4
	DEV TTO7,4
	DEV TTI8,4
	DEV TTO8,4
	DEV CLK,6;	;CLOCK ON LEVEL 6
	DEV PK,6;	;PROGRAMMABLE CLOCK ALSO ON LEVEL 6
	DEV RF,5
	DEV RK,5
	DEV RP,5
	DEV RC,5
	DEV DT,5
	DEV AD,6;	;AD01 A-TO-D, AS PLUG WIRED
	DEV AD7,7;	;AD01, PROG SELECTABLE BR7
;
;PDP-11 DEFINITIONS, PAGE 3
;
;5) MACROS OF INTEREST
;
	DEFINE CANCEL(NM)
<	SKIPN ,NM'UCB+UACT
	POPJ P,
	MOVEI TA3,NM'UCB
	MOVEM TA3,.UCBAD
	PUSHJ P,.CNCEL
	POPJ P,>

	DEFINE ACTIVE(NM,L)
<	SKIPE ,NM'UCB+UACT
	JRST L
	MOVE TA3,TM
	ADD TA3,NM'TIM
	MOVEM TA3,NM'UCB+UTIM
	MOVEI TA3,NM'UCB
	MOVEM TA3,.UCBAD
	PUSHJ P,.ACTVT>

	DEFINE SETINT(NM,ST,L)
<SETDVI:	MOVEI STA,200	;SET DONE BIT IN DEVICE STATUS REG.
	IORB STA,ST
CHKIEB:	TRNN STA,100	;INTERRUPTS ENABLED=1?
	POPJ P,	;NO, EXIT.
SETLVL:	MOVSI TA3,NM'LB	;YES,
	IORM TA3,LVLARY+7-L	;SET BIT IN LEVEL REGISTER.
SETBIT:	TLO PS,IOB'L
	POPJ P,>

	DEFINE CLRINT(NM,ST,L)
<CLRDVI:	MOVEI STA,200	;CLEAR DONE BIT IN STATUS REG.
	ANDCAM STA,ST
CLRLVL:	MOVSI TA3,NM'LB	;CLEAR BIT IN LEVEL REG.
	ANDCAB TA3,LVLARY+7-L
	JUMPN TA3,SETBIT	;IF RESULT 0, CLEAR PS BIT.
	TLZ PS,IOB'L
	POPJ P,>

	DEFINE SETTWO(NM,ST,L)
<SETERR:	MOVEI STA,100000
	JRST .+2
SETDVI:	MOVEI STA,200	;SET DONE BIT IN DEV STATUS REG.
	IORB STA,ST
CHKIEB:	TRNN STA,100	;INTERRUPTS ENABLED=1?
	POPJ P,	;NO, EXIT.
SETLVL:	MOVSI TA3,NM'LB	;YES, SET BIT IN LEVEL REGISTER.
	IORM TA3,LVLARY+7-L
SETBIT:	TLO PS,IOB'L	;SET BIT IN PRIORITIES ACTIVE REGISTER.
	POPJ P,>

;
;PDP-11 DEFINITIONS, PAGE 4
;6) TRAP BIT DEFINITIONS
;TRAP BITS ARE ASSIGNED LEFT TO RIGHT IN 'TR', STARTING AT BIT 1.,
;ACCORDING TO TRAP PRIORITY.
;
	PVBIT=200000	;LEVEL 1--PROTECTION VIOLATION
	IVBIT=100000	;INSTRUCTION VIOLATION (HALT, WAIT, RESET IN USER MODE)
	BUSBIT=040000	;BUS ERROR: ODD ADDR.
	MEMBIT=020000	;BUS ERROR:  NON EXISTANT MEMORY
	ILLBIT=010000	;LEVEL 2-- ILLEGAL MODE WITH JMP/JSR
	RESBIT=004000	;RESERVED INSTRUCTION
	BKBIT=002000	;000003 INSTRUCTION
	IOTBIT=001000	;IOT
	EMTBIT=000400	;EMT
	TRPBIT=000200	;TRAP
	TRCBIT=000100	;LEVEL 3-- TRACE TRAP
	STKBIT=000040	;LEVEL 4-- STACK TRAP
	PWRBIT=000020	;LEVEL 5-- POWER FAILURE TRAP
	LIST
