	TITLE CPUDDM	PDP-11 CPU DESCRIPTOR
	ENTRY CPUDDM
	INTERN PRMODE,MBSAVE,CPUUCB,SYSLST
	INTERN LDRUCB,OFFSET,REG,UR6
	EXTERN PERBNK,.FLAGS,SLPCHK
	INTERN TRPTBL,STM,WFLG,OLDPC,LVLARY,C,CORE,TRREG
	EXTERN CPURST,CPURD,CPUWR,CPUADR,BRSET
	EXTERN BLDUP,TRDOWN,FETCH,LOADER
	EXTERN SR
	EXTERN KSS,KSPC,KSPL,KSRL,KSPH,KSRH
	EXTERN KSAD,KSRW
	INTERN TRPCNT,WPFLAG

	IFNDEF PTR,<	PTR=0>
	IFNDEF PTP,<	PTP=0>
	IFNDEF CPU,<	CPU=^D8>
	MEMSIZ=CPU*^D1024
;
CPUDDM:	DDM1 CPU,CPURDB,CPUUCB
	DDM2 ^D8,^D16,^D8,^D16
	DDM3 QADR+QFIX+QBRK,^D16,MEMSIZ
	DDM4 CPURD,CPUWR,CPURST,CPUADR,BRSET,SLPCHK
;
CPUUCB:	UCB CPU,0,CPUDDM,0,0,QADR+QFIX+QBRK
;
SYSLST:	SIXBIT /PDP11/
	Z ,FETCH
	Z ,CPUPC
	XWD LOADER,LDRUCB
	Z ,BLDUP
	Z ,TRDOWN
	DDM3 QADR+QATBL+QRD,^D36,0
	Z ,STM
;
LDRUCB:	UCB LDR,0,SYSLST,0,0,QADR+QATBL+QRD
;
OFFSET:	Z	;LOADER OFFSET
;
	CORE=CPUDDM+DNFRM
;
;PDP-11 CPU DDM, PAGE 2
;
	DEFINE TT(B,V)	;TRAP TABLE MACRO
<	XWD B,V>

TRPTBL:	TT PVBIT+BUSBIT+MEMBIT+TRCBIT,4	; 1=PROTECTION VIOLATION
	TT IVBIT+BUSBIT+MEMBIT+TRCBIT,4	;2= INSTRUCTION VIOLATION
	TT BUSBIT+MEMBIT+TRCBIT,4	;3= BUS ERROR
	TT BUSBIT+MEMBIT+TRCBIT,4	;4= MEM ERROR
	TT ILLBIT+TRCBIT,4	;5= ILL INSTR ERROR
	TT RESBIT+TRCBIT,10	;6= RESERVED INSTR ERROR
	TT BKBIT+TRCBIT,14	;7= BKPT INSTR
	TT IOTBIT+TRCBIT,20	;8= IOT INSTR
	TT EMTBIT+TRCBIT,30	;9= EMT INSTR
	TT TRPBIT+TRCBIT,34	;10= TRAP INSTR
	TT TRCBIT+STKBIT,14	;11= TRACE TRAP
	TT STKBIT,4	;12= STACK TRAP
	TT PWRBIT,24	;13= POWER FAIL TRAP
;
WPFLAG:	Z	;SEG IS WRITE PROTECTED FLAG
TRPCNT:	Z	;COUNT OF SEQUENTIAL TRAPS
PRMODE:	XWD ^D8,^D16	;PREVAILING MODE SWITCH.
PSCORE:	MEMSIZ	;CORE REGISTER.
STM:	REPEAT 13,<	Z>	;SAVED FAST REGISTERS.
WFLG:	Z	;WAIT STATE TRAP FLAG.
MBSAVE:	Z	;TEMPORARY
REG:	REPEAT 10,<	Z>	;PDP-11 FAST REGISTERS.
UR6:	Z	;USER R6
OLDPC:	Z	;OLD PC.
LVLARY:	Z	;LEVEL STATUS REGISTERS:  BR7
	Z	;BR6
	Z	;BR5
	Z	;BR4
;
CPURDB:	RDB R0,REG+0,16	;PDP-11 GENERAL REGISTERS.
	RDB R1,REG+1,16
	RDB R2,REG+2,16
	RDB R3,REG+3,16
	RDB R4,REG+4,16
	RDB R5,REG+5,16
	RDB MR6,REG+6,16	;MONITOR R6
	RDB UR6,UR6,16		;USER R6
	RDB R7,REG+7,16
	RDB KSS,KSS,16	;KS11  STATUS
	RDB KSPL,KSPL,16	;KS11 LOW SEG PROTECTION
	RDB KSRL,KSRL,16	;KS11 LOW SEG RELOCATION
	RDB KSPH,KSPH,16	;KS11 HIGH SEG PROTECTION
	RDB KSRH,KSRH,16	;KS11 HIGH SEG RELOCATION
	RDB KSPC,KSPC,16	;KS11 PC SAVE
	RDB KSAD,KSAD,16	;KS11 RELOCATION WINDOW ADDRESS
	RDB KSRW,KSRW,16	;KS11 RELOCATION WINDOW
	RDB PS,STM+PS,16	;PROCESSOR STATUS.
	RBLK STAT,STM+PS,4,,8,3	;PRIORITIES ACTIVE REG.
	RBLK BR7,LVLARY+0,30,P,8,29	;LEVEL STATUS REGISTERS
	RBLK BR6,LVLARY+1,30,P,8,29	;ARE STORED LEFT JUSTIFIED
	RBLK BR5,LVLARY+2,30,P,8,29	;IN LVLARY
	RBLK BR4,LVLARY+3,30,P,8,29
	RDB SR,SR,16	;CONSOLE SWITCHES.
	RBLK OTR,STM+TR,13,,2,13	;OUTSTANDING TRAPS.
	RDB OLDPC,OLDPC,16,P	;OLD PC.
	RDB MSP,REG+6,16	;MONITOR STACK POINTER=MR6
	RDB USP,UR6,16	;USER STACK POINTER = UR6
CPUPC:	RDB PC,REG+7,16	;PC=R7
	RDB CC,STM+PS,4	;CONDITION CODE
	RBLK LEVEL,STM+PS,3,,8,30	;PROCESSOR LEVEL.
	FLG UM,STM+PS,20	;USER MODE
	FLG MHR,STM+PS,21	;MONITOR HIGH SEG RELOC
	FLG DREL,STM+PS,22	;DESTINATION RELOCATE
	FLG SREL,STM+PS,23	;SOURCE RELOCATE
	FLG UIO,STM+PS,24	;USER I/O
	FLG EAEENB,STM+PS,25	;EAE ENABLE
	FLG USPS,STM+PS,26	;USER STACK POINTER
	FLG KSSER,KSS,20
	FLG KSSPV,KSS,21	;KSS ERROR FLAGS
	FLG KSSIV,KSS,22
	FLG KSSSD,KSS,28
	FLG UTRP,KSPL,34
	FLG WPL,KSPL,35
	FLG WPH,KSPH,35
	DRDB TM,STM,36,P
	DRDB CORE,PSCORE,16,P
	FLG SINGLE,.FLAGS,1	;SINGLE INST TRAP FLAG.
	FLG SI,.FLAGS,1	;SIN INST TRAP ABBREVIATION
	RDB MA,STM+MA,18,P	;MEMORY ADDRESS.
	RDB MB,STM+MB,16,P	;MEMORY BUFFER.
	DRDB MODE,CPUDDM+DVAL,5,P	;THIS REGISTER IS HERE SO
		;THAT GET CAN FORCE THE CPU EX/MOD MODE BACK
		;TO THE MODE OF THE SAVED FILE.
	RDB OFFSET,OFFSET,18
TRREG:	FLG WAIT,WFLG,0	;WAIT STATE FLAG.
	FLG PV,TRPTBL,0	;PROTECTION VIOLATION TRAP
	FLG IV,TRPTBL+1,0
	FLG BUS,TRPTBL+2,0	;TRAP FLAGS.
	FLG MEM,TRPTBL+3,0
	FLG ILLEG,TRPTBL+4,0
	FLG RSV,TRPTBL+5,0
	FLG BRK,TRPTBL+6,0
	FLG IOT,TRPTBL+7,0
	FLG EMT,TRPTBL+8,0
	FLG TRP,TRPTBL+9,0
	FLG TRC,TRPTBL+10,0
	FLG STK,TRPTBL+11,0
	FLG PWR,TRPTBL+12,0
	Z
;
C:	XLIST
	REPEAT MEMSIZ/2,<	Z>
	LIST
	RELOC CPUDDM+DSYN
	EXTERN PDP11S
	PDP11S	;DEVICE SYNTAX.
	END
