	TITLE COMMON	MIMIC RELEASE II LOW SEGMENT
	IFE ADR!TIMLTD!ONLINE!TYMSHR!DIGITL!FDATA!ISC!DTALIN,<ADR==1>
	LOC 137
	BYTE (3)0(9)2(6)7(18)0	;VERSION 2.7
		;PATCH LEVEL 0= ORIGINAL RELEASE
		;PATCH LEVEL 1= CORRECTION OF VM-BUSY FLAG BUG
		;		AND HALF DUPLEX CONSOLE TTY BUG.
		;PATCH LEVEL 2= CONVERSION TO 5.03B, USE OF HIBER UUO,
		;		CORRECTION OF FILE NAME BUG AND
		;		MULTIPLE CONTROLLERS BUG.
		;PATCH LEVEL 3=	CORRECTION OF REG_ BUG, OF REG,REG?
		;		BUG, AND OF BR XXXX_(!6) BUG
		;PATCH LEVEL 4= ^+CHARACTER CONTROL-CHAR CONVENTION
		;PATCH LEVEL 5=	ASCII/IMAGE COMMANDS, TIMER/ITIMER COMMANDS,
		;		LOCAL TERMINATORS FOR REGISTERS,
		;		ATTACH/DETACH BREAKOUT, ^C CLEANUP,
		;		ZERO COMPRESSED SAVE/GET
		;PATCH LEVEL 6=	ELIMINATION OF DDT SUBMODE FOR COMMAND
		;		INPUT, 18 BIT PPN'S TYPED OUT ON ERROR
		;PATCH LEVEL 7=	36 BIT EX/MOD, CIO OVERHAUL, ONCE
		;		ONLY INTIALIZATION, "P" ADDR MODE IN SM,
		;		POSITION INDEPENDANT CDMLST.
;
;HISEG DEV & PPN:
;
IFN ADR,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 640,640
	INSNAM=SIXBIT/ADR/>
IFN DIGITL,<LIBDEV=SIXBIT/SYS/
	LIBPPN=XWD 0,0
	INSNAM=SIXBIT/DIGITL/>
IFN ONLINE,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 10,12
	INSNAM=SIXBIT/ONLINE/>
IFN FDATA,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 11,1000
	INSNAM=SIXBIT/FDATA/>
IFN DTALIN,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 1,10
	INSNAM=SIXBIT/DTALIN/>
IFN TYMSHR,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 13,54420
	INSNAM=SIXBIT/TYMSHR/>
IFN ISC,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 6,41
	INSNAM=SIXBIT/ISC/>
IFN TIMLTD,<LIBDEV=SIXBIT/DSK/
	LIBPPN=XWD 404,404
	INSNAM=SIXBIT/TIMLTD/>
;
	RELOC 0
;
;LOW SEGMENT PSEUDO STARTING ADDRESS
;
	EXTERN MIMIC
NOGO:	TTCALL 3,.+2	;IF ATTEMPT TO START WITHOUT
	CALLI 0,12	;USING MIMIC COMMAND, GIVE NASTY MESSAGE.
	ASCIZ /USE MIMIC COMMAND
/
INSTLN:	INSNAM		;INSTALLATION NAME, SIXBIT
;
	RELOC NOGO+10	;REAL START IS AT APPARENT START+10
LOWGO:	MOVEI 1,LOWBLK	;DO GETSEG TO GET REAL HIGH SEGMENT
	CALLI 1,40
	HALT
	JRST MIMIC
;
LOWBLK:	LIBDEV
	SIXBIT /MIMV27/
	SIXBIT /SHR/
	Z
	LIBPPN
	Z
.FLAGS:	BLOCK 1	;SYSTEM FLAGS IN LOCATION 162.
;
;BCTSRV AND BREAK COMMON
;
	INTERN BCTBOT,BCTTOP,BCTLIM,CTYSTA
	INTERN BRKPTR,OLDPTR,SYNPTR,COMPTR,STKSAV,STKINI
	EXTERN CONSYN
;
BCTBOT:	BLOCK 1	;POINTS TO 1ST BCT ENTRY
BCTTOP:	BLOCK 1	;POINTS TO LAST BCT ENTRY
BCTLIM:	BLOCK 1	;END OF LOW SEGMENT
BRKPTR:	BLOCK 1	;PTRS FOR BCT SEARCH
OLDPTR:	BLOCK 1
STKINI:	IOWD 177,STACK+1	;IOWD FOR CLEAR STACK:
STKSAV:	IOWD 177,STACK+1	;STACK HAS ONE WORD PUSHED ONTO IT.
SYNPTR:	Z ,CONSYN	;PTR TO MAIN SYNTAX
COMPTR:	Z ,COMTXT	;PTR TO COMMAND BUFFER
CTYSTA:	Z		;SAVED STATUS OF USER'S CTY
;COMMON, PAGE 2
;SM COMMON
;
	EXTERN CPUUCB,CPUDDM
	INTERN SMGR,GRTBL,SMOLDPC
	INTERN ERROR,JUNK,CSSLVL
;
SMGR:GRTBL:	BLOCK XDFUADR	;SM GENERAL REGISTERS
	Z ,CPUUCB	;INITIALIZED DEFAULT REGISTERS
	Z ,CPUDDM
	BLOCK ^D64-<.-SMGR>
SMOLDPC:	BLOCK 1	;SM OLD PC
JUNK:	BLOCK 1	;TEMPORARY WORD
CSSLVL:	BLOCK 1	;SYNTAX LEVEL
ERROR:	JRST .+1	;TEMPORARY ERROR HANDLER
	HALT
;COMMON, PAGE 3
;REDWRT COMMON
;
	INTERN DIGCNT,DIGTST
	INTERN NOLEAD,LEADER
;
DIGCNT:	BLOCK 1	;TEMPORARIES FOR REDWRT
DIGTST:	BLOCK 1
NOLEAD:	Z	;NO LEADING CHARACTERS FLAG.
LEADER:	60	;LEADING CHARACTER IS ZERO.
;
;SAVE/GET COMMON
;
	EXTERN NULL,.READ,.WRITE	;WHEN SAVE/GET WORKS, WE
	INTERN SAVDDM,SAVUCB,UNSTAT
	INTERN CORFLG,UNTFLG,CONFLG
CORFLG:	BLOCK 1	;FLAGS USGD IN ERROR PROCESSING.
UNTFLG:	BLOCK 1
CONFLG:	BLOCK 1
UNSTAT:	BLOCK 1	;SAVED STATUS
SAVDDM:	DDM3 QADR+QATBL,^D36,0
SAVUCB:	UCB SAV,0,SAVDDM-DSTAT,0,0,QADR+QATBL
;
;DUMP COMMON
;
	EXTERN DMPSRV
	INTERN DMPUCB
DMPDDM:	DDM3 QADR+QATBL,7,0
DMPUCB:	UCB DMP,0,DMPDDM-DSTAT,DMPSRV,0,QADR+QATBL
;COMMON, PAGE 4
;EDITOR COMMON
;
	INTERN COMTXT
COMTXT:	BLOCK ^D14	;COMMAND BUFFER
;COMMON, PAGE 5
;CIO COMMON
;
	INTERN .EVNTM,.ACTVQ,.FLAGS
	INTERN CONUCB,CHLTBL,OPNBLK
;
OPNBLK:	17		;OPEN BLOCK-- DUMP MODE
	SIXBIT /DSK/	;TO DISK
	0
.EVNTM:	377777777777	;EVENT TIME OF NULL LIST.
.ACTVQ:	-1	;POINTER TO ACTIVE LIST (-1 = EMPTY)
CONUCB:	Z	;CONSOLE UCB
	377777777777
	BLOCK ^D8
CHLTBL:	REPEAT ^D15,<	-1>	;CHANNEL TABLE.  -1=FREE, OTHER=IN USE
IFE ONLINE+TIMLTD,<	-1>
IFN ONLINE+TIMLTD,<	Z>		;CHL 17 UNAVAILABLE
IFN ONLINE,<
	INTERN BILARG,XYOLSZ
BILARG:	ASCII /MIMSH/
	ASCII /R.ADR/
	ASCII /ROYAL/
	ASCII /CHG/
	10
	13
	0
	0
	0
	0
	0.5	;SURCHARGE ON CP UNITS
	0	;SURCHARGE ON CONNECT
	0	;MINIMUM CHARGE
XYOLSZ:	REPEAT ^D160,<0>>
;
IFN TYMSHR,<	INTERN BRI,BRCP,BRF
	EXTERN VALPRI
BRI:	JSA 16,VALPRI	;WRITE INITIAL BILLING RECORD
	ARG 0,IBR
	ARG 0,IPCODE
	ARG 5,BFNAME
	POPJ P,
;
BRCP:	JSA 16,VALPRI	;WRITE CHECKPOINT BILLING RECORD
	ARG 0,CPBR
	ARG 0,IPCODE
	ARG 5,BFNAME
	POPJ P,
;
BRF:	JSA 16,VALPRI	;WRITE FINAL BILLING RECORD
	ARG 0,FBR
	ARG 0,IPCODE
	ARG 5,BFNAME
	POPJ P,
;
IBR:	3		;BILLING CODES
CPBR:	1
FBR:	4
IPCODE:	^D318		;PROGRAM CODE FOR MIMIC
BFNAME:	ASCII /BILIN/	;BILLING FILE NAME
>

;
IFN TIMLTD,<		;LOW SEGMENT FOR BILLING ROUTINE

DSKBUF:: BLOCK 16
ILIST::  BLOCK 2
OLIST::  BLOCK 2
FCTBLK:: BLOCK 2
FCTBUF:: BLOCK 200
FCTEND::

PDL::	 BLOCK 6
SAFE::	 BLOCK 10
>
;COMMON, PAGE 6
;CONSYN COMMON
;
	INTERN BRKIDS,ACTPTR,ATMLST
	INTERN STACK,PATCH,CDMLSP,SYSLSP,CDMPTR
	EXTERN CDMLST,SYSLST
;
BRKIDS:	SIXBIT /E/	;BREAK IDENTIFIERS
	SIXBIT /N/
	SIXBIT /R/
	SIXBIT /W/
	SIXBIT /I/
	SIXBIT /O/
	SIXBIT /S/
	Z
	BLOCK ^D18-<.-BRKIDS>
STACK:	Z ,ERROR	;PHONY INITIAL CALL FROM VM TO CONSOLE.
	BLOCK 177	;STACK PROPER
PATCH:	BLOCK 100
ATMLST:	BLOCK ^D36	;ATOM LIST
CDMLSP:	Z ,CDMLST	;PTR TO CDM LIST
SYSLSP:	Z ,SYSLST	;PTR TO SYSTEM LIST
CDMPTR:	BLOCK 1		;TEMP POINTER TO CDM LIST
ACTPTR:	POINT 6,A1	;PTRS TO ACTION BUFFERS.
	POINT 6,A2
	POINT 6,A3
	POINT 6,A4
	POINT 6,A5
	POINT 6,A6
	POINT 6,A7
	POINT 6,A8
	POINT 6,A9
	POINT 6,A10
	POINT 6,A11
	POINT 6,A12
	POINT 6,A13
	POINT 6,A14
	POINT 6,A15
	POINT 6,A16
	POINT 6,A17
	POINT 6,A18
	POINT 6,A19
	POINT 6,A20
	POINT 6,A21
	POINT 6,A22
	POINT 6,A23
	POINT 6,A24
	POINT 6,A25
	POINT 6,A26
	POINT 6,A27
	POINT 6,A28
	POINT 6,A29
	POINT 6,A30
	POINT 6,A31
	POINT 6,A32
	POINT 6,A33
	POINT 6,A34
	POINT 6,A35
	POINT 6,ACTONC
	Z
;COMMON, PAGE 7
;ACTION BUFFERS
;
	DEFINE ABF
<	Z
	BLOCK ACTSIZ>
A1:	ABF
A2:	ABF
A3:	ABF
A4:	ABF
A5:	ABF
A6:	ABF
A7:	ABF
A8:	ABF
A9:	ABF
A10:	ABF
A11:	ABF
A12:	ABF
A13:	ABF
A14:	ABF
A15:	ABF
A16:	ABF
A17:	ABF
A18:	ABF
A19:	ABF
A20:	ABF
A21:	ABF
A22:	ABF
A23:	ABF
A24:	ABF
A25:	ABF
A26:	ABF
A27:	ABF
A28:	ABF
A29:	ABF
A30:	ABF
A31:	ABF
A32:	ABF
A33:	ABF
A34:	ABF
A35:	ABF
ACTONC:	SIXBIT /CON#$/
	BLOCK ACTSIZ
;

;COMMON, PAGE 8
;CONDITIONAL CODE FOR CONTROL-C TRAPPING. IF ENABLED, THIS
;CODE ALLOWS MIMIC TO FIELD CONTROL-C, THEREBY PERMITTING
;MIMIC TO STRAIGHTEN OUT THE STATE OF THE CONSOLE TTY.

IFN CCTRAP,<
	LOC 134		;SET POINTER IN .JBINT POINTING
	EXP INTBLK	;TO INTERRUPT BLOCK.

	RELOC
	INTERN INTBLK
INTBLK:	XWD 4,INTLOC	;4 WORDS LONG,,PLACE TO START
	XWD 0,2		;NO MESSAGE CONTROL,,^C TRAP
	Z		;SAVED PC ON INTERRUPT
	Z		;LH GETS INTERRUPT TYPE

INTLOC:	MOVEM 16,SAV16	;SAVE AC-16.
	TTCALL 7,CTYSTAT	;RESTORE ORIGINAL CTY STATUS.
IFN TIMLTD,<	EXTERN CHARGE
	JSP 16,CHARGE	;WRITE TERMINAL RECORD
	JUMP 0,2
	JUMP 0,[ASCII/MIM1/]
>
IFN TYMSHR,<
	PUSHJ P,BRCP	;WRITE AN INTERMEDIATE RECORD
>
	EXIT 1,		;EXIT TO MONITOR.
IFN TIMLTD,<
	JSP 16,CHARGE	;WRITE NEW INITIAL RECORD.
	JUMP 0,1
	JUMP 0,[ASCII/MIM1/]
>
	MOVE 16,INTBLK+2	;GET SAVED PC
	EXCH 16,SAV16	;RESTORE AC, SAVED PC TO CORE.
	SETZM INTBLK+2	;RE-ENABLE INTERRUPT.
	JRSTF @SAV16	;RETURN
SAV16:	BLOCK 1		;TEMPORARY
>
	END NOGO
